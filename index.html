<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Roblox AI Assistant Beta - Especialista em Scripts Luau</title>
    <meta name="description" content="Assistente IA especializado em Roblox Studio para gerar e revisar scripts Luau com interface estilo ChatGPT.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
/* Roblox AI Assistant Beta - ChatGPT Style v2.1 */

:root {
    /* Dark mode (default) */
    --bg-primary: #0f0f23;
    --bg-secondary: #1a1a2e;
    --bg-tertiary: #16213e;
    --bg-chat: #343541;
    --bg-user: #444654;
    --bg-assistant: #343541;
    --accent-primary: #10a37f;
    --accent-secondary: #19c37d;
    --text-primary: #ffffff;
    --text-secondary: #d1d5db;
    --text-muted: #9ca3af;
    --text-code: #e5e7eb;
    --code-bg: #0d1117;
    --code-border: #30363d;
    --border-color: #374151;
    --shadow-primary: 0 4px 16px rgba(0,0,0,0.4);
    --shadow-hover: 0 8px 24px rgba(16, 163, 127, 0.2);
    --border-radius: 12px;
    --transition: all 0.3s ease;
    --sidebar-width: 280px;
}

/* Light mode */
.light-mode {
    --bg-primary: #ffffff;
    --bg-secondary: #f8fafc;
    --bg-tertiary: #f1f5f9;
    --bg-chat: #ffffff;
    --bg-user: #f0f9ff;
    --bg-assistant: #ffffff;
    --accent-primary: #059669;
    --accent-secondary: #10b981;
    --text-primary: #1f2937;
    --text-secondary: #374151;
    --text-muted: #6b7280;
    --text-code: #1f2937;
    --code-bg: #f8fafc;
    --code-border: #e5e7eb;
    --border-color: #e5e7eb;
    --shadow-primary: 0 4px 16px rgba(0,0,0,0.1);
    --shadow-hover: 0 8px 24px rgba(5, 150, 105, 0.15);
}

* {
    box-sizing: border-box;
}

body {
    background: var(--bg-primary);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    color: var(--text-primary);
    margin: 0;
    padding: 0;
    line-height: 1.6;
    transition: var(--transition);
    overflow-x: hidden;
}

/* Sidebar Styles */
.sidebar {
    position: fixed;
    top: 0;
    left: -280px;
    width: 280px;
    height: 100vh;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    transition: transform 0.3s ease-in-out;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-primary);
    overflow: hidden;
    transform: translateX(0);
}

.sidebar.show {
    transform: translateX(280px) !important;
}

.sidebar-header {
    padding: 1.5rem 1rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.sidebar-title {
    color: var(--text-primary);
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.sidebar-footer {
    padding: 1rem;
    border-top: 1px solid var(--border-color);
}

.chat-history {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.chat-item {
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    border: 1px solid transparent;
}

.chat-item:hover {
    background: var(--bg-chat);
    border-color: var(--accent-primary);
}

.chat-item.active {
    background: var(--accent-primary);
    color: white;
}

.chat-item-title {
    font-weight: 500;
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.chat-item-preview {
    font-size: 0.8rem;
    color: var(--text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.chat-item-date {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

/* Sidebar Toggle Button */
.sidebar-toggle {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1001;
    background: var(--accent-primary);
    color: white;
    border: none;
    border-radius: 8px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: var(--shadow-primary);
}

.sidebar-toggle:hover {
    background: var(--accent-secondary);
    transform: scale(1.05);
}

.sidebar-toggle:active {
    transform: scale(0.95);
}

/* Main Content */
.main-content {
    transition: margin-left 0.3s ease-in-out;
    min-height: 100vh;
    position: relative;
    width: 100%;
}

.main-content.shifted {
    margin-left: 280px;
}

/* Cards and Form Elements */
.card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.form-control {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    border-radius: 8px;
    transition: var(--transition);
}

.form-control:focus {
    background: var(--bg-tertiary);
    border-color: var(--accent-primary);
    color: var(--text-primary);
    box-shadow: 0 0 0 0.2rem rgba(16, 163, 127, 0.25);
}

.form-control::placeholder {
    color: var(--text-muted);
}

.btn-primary {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    border-radius: 8px;
    transition: var(--transition);
}

.btn-primary:hover {
    background: var(--accent-secondary);
    border-color: var(--accent-secondary);
}

.btn-success {
    background: #059669;
    border-color: #059669;
    border-radius: 8px;
}

.btn-success:hover {
    background: #047857;
    border-color: #047857;
}

pre {
    background: var(--code-bg) !important;
    color: var(--text-code) !important;
    border: 1px solid var(--code-border);
    border-radius: 8px;
    padding: 1rem;
    overflow-x: auto;
    font-size: 0.9rem;
    /* --- ALTERA√á√ïES INTELIGENTES --- */
    max-height: 70vh; /* Define a altura m√°xima para 70% da tela */
    overflow-y: auto; /* Adiciona rolagem vertical se necess√°rio */
    white-space: pre-wrap; /* Quebra a linha de c√≥digos longos */
    word-wrap: break-word; /* Garante a quebra de palavras */
}

.alert {
    border-radius: 8px;
    border: none;
}

.text-primary {
    color: var(--accent-primary) !important;
}

.text-muted {
    color: var(--text-muted) !important;
}

/* Theme Toggle */
.theme-controls .btn {
    border-radius: 20px;
    padding: 0.5rem 1rem;
    transition: var(--transition);
}

/* Header Styles */
.header-section {
    text-align: center;
    margin-bottom: 2rem;
    padding: 2rem 0;
}

.display-4 {
    font-weight: 700;
    margin-bottom: 1rem;
}

.lead {
    font-size: 1.2rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 0 1rem;
    }
    
    .header-section {
        text-align: center;
        padding: 1rem 0;
    }
    
    .display-4 {
        font-size: 2rem;
    }
    
    .main-content.shifted {
        margin-left: 0;
    }
    
    .btn {
        padding: 0.75rem 1rem;
    }
    
    .sidebar {
        width: 100vw;
        left: -100vw;
        transform: translateX(0);
    }
    
    .sidebar.show {
        transform: translateX(100vw) !important;
    }
}

/* Animations */
@keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fade-in 0.3s ease-out;
}

@keyframes slide-in-left {
    from { transform: translateX(-100%); }
    to { transform: translateX(0); }
}

@keyframes slide-out-left {
    from { transform: translateX(0); }
    to { transform: translateX(-100%); }
}

/* Loading States */
.btn.loading {
    position: relative;
    color: transparent !important;
}

.btn.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    margin: -8px 0 0 -8px;
    width: 16px;
    height: 16px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Scrollbar Styling */
.sidebar-content::-webkit-scrollbar {
    width: 6px;
}

.sidebar-content::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

.sidebar-content::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}

.sidebar-content::-webkit-scrollbar-thumb:hover {
    background: var(--accent-primary);
}
    </style>
</head>
<body class="dark-mode">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="sidebar-title">Conversas</h5>
                <button class="btn btn-sm btn-outline-secondary" id="newChatBtn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="sidebar-content">
            <div id="chatHistory" class="chat-history">
                <!-- Chat history will be populated here -->
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="btn btn-outline-danger btn-sm w-100 mb-2" id="clearHistoryBtn">
                <i class="fas fa-trash"></i> Limpar Hist√≥rico
            </button>
        </div>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Abrir menu" type="button">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="header-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h1 class="display-4 text-primary mb-0">
                                <i class="fas fa-robot me-3"></i>
                                Roblox AI Assistant <span class="badge bg-warning text-dark">BETA</span>
                            </h1>
                        </div>
                        <div class="theme-controls">
                            <button class="btn btn-outline-secondary btn-sm" id="themeToggle">
                                <i class="fas fa-moon" id="themeIcon"></i>
                                <span id="themeText">Modo Claro</span>
                            </button>
                        </div>
                    </div>
                    <p class="lead">Especialista em Roblox Studio ‚Ä¢ Scripts Luau ‚Ä¢ Intelig√™ncia Artificial</p>
                    <p class="text-muted">Assistente IA especializado com interface moderna estilo ChatGPT</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Script Generator -->
            <div class="col-lg-6 mb-4">
                <!-- ALTERA√á√ÉO: Removido 'h-100' para permitir altura din√¢mica -->
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-code me-2"></i>
                            Gerador de Scripts
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="generateForm">
                            <div class="mb-3">
                                <label for="scriptDescription" class="form-label">Descreva seu script em detalhes:</label>
                                <textarea 
                                    class="form-control" 
                                    id="scriptDescription" 
                                    rows="10" /* ALTERA√á√ÉO: Aumentado de 5 para 10 linhas */
                                    placeholder="Ex: Crie um sistema de loja que permite comprar itens com moedas do jogo. O script deve validar se o jogador tem moedas suficientes, processar a compra no servidor e atualizar o invent√°rio..."
                                    required
                                ></textarea>
                                <div class="form-text">üí° Seja espec√≠fico sobre funcionalidades, onde colocar o script (ServerScript/LocalScript) e comportamentos esperados</div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="generateBtn">
                                <i class="fas fa-magic me-2"></i>
                                Gerar Script
                            </button>
                        </form>
                        
                        <div id="generateResult" class="mt-3" style="display: none;">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle me-2"></i>Script Gerado:</h6>
                                <pre id="generatedScript" class="bg-dark text-light p-3 rounded mt-2"></pre>
                                <div class="mt-2">
                                    <button class="btn btn-outline-success btn-sm me-2" onclick="copyToClipboard('generatedScript')">
                                        <i class="fas fa-copy me-1"></i>Copiar
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="saveToHistory('generate')">
                                        <i class="fas fa-save me-1"></i>Salvar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="generateError" class="mt-3" style="display: none;">
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>Erro:</h6>
                                <p id="generateErrorMsg" class="mb-0"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Script Reviewer -->
            <div class="col-lg-6 mb-4">
                 <!-- ALTERA√á√ÉO: Removido 'h-100' para permitir altura din√¢mica -->
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-search me-2"></i>
                            Revisor de Scripts
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="reviewForm">
                            <div class="mb-3">
                                <label for="scriptFile" class="form-label">Selecione um arquivo de script (.lua, .luau, .txt):</label>
                                <input 
                                    type="file" 
                                    class="form-control" 
                                    id="scriptFile" 
                                    accept=".lua,.luau,.txt"
                                    required
                                >
                            </div>
                            <button type="submit" class="btn btn-success w-100" id="reviewBtn">
                                <i class="fas fa-analyze me-2"></i>
                                Revisar Script
                            </button>
                        </form>
                        
                        <div id="reviewResult" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-clipboard-check me-2"></i>An√°lise do Script:</h6>
                                <div class="mt-2">
                                    <strong>Arquivo:</strong> <span id="reviewFilename"></span><br>
                                    <strong>Classifica√ß√£o:</strong> <span id="reviewRating" class="badge bg-primary"></span>
                                </div>
                                <div class="mt-3">
                                    <h6>An√°lise:</h6>
                                    <div id="reviewAnalysis" class="bg-light p-2 rounded"></div>
                                </div>
                                <div class="mt-3">
                                    <h6>Sugest√µes:</h6>
                                    <ul id="reviewSuggestions" class="mb-0"></ul>
                                </div>
                            </div>
                        </div>
                        
                        <div id="reviewError" class="mt-3" style="display: none;">
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>Erro:</h6>
                                <p id="reviewErrorMsg" class="mb-0"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="text-center text-muted">
                    <p>
                        <i class="fas fa-info-circle me-2"></i>
                        Powered by OpenAI GPT-4o | 
                        <a href="https://github.com/seu-usuario/roblox-ai-assistant" target="_blank" class="text-decoration-none">
                            <i class="fab fa-github me-1"></i>GitHub
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
// Roblox AI Assistant JavaScript - v2.1 BETA com Sidebar e Temas
// Configura√ß√£o da API externa do usu√°rio
const API_KEY = "sk-YFtEcctGY3Vq8UiyRoGxh7JzJ4QHzccM9nqCSGR559LghMRf";
const API_URL = "https://api.chatanywhere.tech/v1";

// Cache para melhor performance
const cache = new Map();
const MAX_CACHE_SIZE = 50;

// Sistema de hist√≥rico e persist√™ncia
let chatHistory = [];
let currentChatId = null;

// Configura√ß√µes de cookies
const COOKIE_EXPIRY_DAYS = 30;

document.addEventListener('DOMContentLoaded', function() {
    const generateForm = document.getElementById('generateForm');
    const reviewForm = document.getElementById('reviewForm');
    
    // Inicializa√ß√£o
    initializeApp();
    initializeSidebar();
    initializeTheme();
    
    // Handle script generation com API externa
    generateForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const description = document.getElementById('scriptDescription').value.trim();
        const generateBtn = document.getElementById('generateBtn');
        const resultDiv = document.getElementById('generateResult');
        const errorDiv = document.getElementById('generateError');
        
        if (!description || description.length < 5) {
            showError('generateError', 'Por favor, forne√ßa uma descri√ß√£o mais detalhada (m√≠nimo 5 caracteres).');
            return;
        }
        
        // Check cache first
        const cacheKey = `generate_${description}`;
        if (cache.has(cacheKey)) {
            const cachedResult = cache.get(cacheKey);
            document.getElementById('generatedScript').textContent = cachedResult;
            showElement(resultDiv, 'fade-in');
            return;
        }
        
        // Reset previous results
        hideElement(resultDiv);
        hideElement(errorDiv);
        
        // Show loading state
        setLoading(generateBtn, true);
        
        try {
            const response = await fetch(`${API_URL}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        {
                            role: "system",
                            content: "Voc√™ √© um ESPECIALISTA AVAN√áADO em Roblox Studio e programa√ß√£o Luau. " +
                                   "Caracter√≠sticas importantes: " +
                                   "‚Ä¢ Conhe√ßa TODOS os servi√ßos do Roblox (Players, Workspace, ReplicatedStorage, etc.) " +
                                   "‚Ä¢ Use RemoteEvents e RemoteFunctions corretamente para client-server " +
                                   "‚Ä¢ Implemente padr√µes como MVC, Singleton quando apropriado " +
                                   "‚Ä¢ Crie scripts otimizados e eficientes " +
                                   "‚Ä¢ Sempre inclua coment√°rios detalhados em portugu√™s " +
                                   "‚Ä¢ Use ModuleScripts para organiza√ß√£o de c√≥digo " +
                                   "‚Ä¢ Implemente tratamento de erros robusto " +
                                   "‚Ä¢ Siga as melhores pr√°ticas de seguran√ßa do Roblox " +
                                   "‚Ä¢ Use DataStores corretamente para persist√™ncia " +
                                   "‚Ä¢ Otimize para performance e experi√™ncia do usu√°rio " +
                                   "IMPORTANTE: Sempre especifique onde colocar o script (ServerScriptService, StarterGui, ReplicatedStorage, etc.)"
                        },
                        {
                            role: "user",
                            content: `Crie um script Luau para Roblox Studio com a seguinte descri√ß√£o: ${description}\n\n` +
                                   "Inclua coment√°rios explicativos em portugu√™s e especifique onde colocar o script."
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            const generatedScript = data.choices[0].message.content;
            
            // Cache result
            cache.set(cacheKey, generatedScript);
            if (cache.size > MAX_CACHE_SIZE) {
                cache.delete(cache.keys().next().value);
            }
            
            document.getElementById('generatedScript').textContent = generatedScript;
            showElement(resultDiv, 'fade-in');
            
            // Add to history
            addToHistory('generate', description, generatedScript);
            
        } catch (error) {
            console.error('Erro na gera√ß√£o:', error);
            showError('generateError', `Erro ao gerar script: ${error.message}`);
        } finally {
            setLoading(generateBtn, false);
        }
    });

    // Handle script review
    reviewForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('scriptFile');
        const reviewBtn = document.getElementById('reviewBtn');
        const resultDiv = document.getElementById('reviewResult');
        const errorDiv = document.getElementById('reviewError');
        
        if (!fileInput.files.length) {
            showError('reviewError', 'Por favor, selecione um arquivo.');
            return;
        }
        
        const file = fileInput.files[0];
        const maxSize = 100 * 1024; // 100KB
        
        if (file.size > maxSize) {
            showError('reviewError', 'Arquivo muito grande. M√°ximo: 100KB');
            return;
        }
        
        // Reset previous results
        hideElement(resultDiv);
        hideElement(errorDiv);
        
        // Show loading state
        setLoading(reviewBtn, true);
        
        try {
            const scriptContent = await readFileAsync(file);
            
            const response = await fetch(`${API_URL}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        {
                            role: "system",
                            content: "Voc√™ √© um ESPECIALISTA em revis√£o de c√≥digo Roblox Studio e Luau. " +
                                   "Analise o c√≥digo fornecido considerando: " +
                                   "‚Ä¢ Sintaxe e estrutura correta " +
                                   "‚Ä¢ Uso adequado dos servi√ßos do Roblox " +
                                   "‚Ä¢ Performance e otimiza√ß√£o " +
                                   "‚Ä¢ Seguran√ßa e vulnerabilidades " +
                                   "‚Ä¢ Boas pr√°ticas de programa√ß√£o " +
                                   "‚Ä¢ Padr√µes de c√≥digo limpo " +
                                   "‚Ä¢ Tratamento de erros " +
                                   "Forne√ßa uma an√°lise detalhada e sugest√µes de melhoria em portugu√™s."
                        },
                        {
                            role: "user",
                            content: `Revise este script Luau para Roblox Studio:\n\n\`\`\`lua\n${scriptContent}\n\`\`\`\n\n` +
                                   "Forne√ßa uma an√°lise detalhada, classifica√ß√£o de 1 a 5 estrelas, e sugest√µes de melhoria."
                        }
                    ],
                    max_tokens: 1500,
                    temperature: 0.3
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            const review = data.choices[0].message.content;
            
            // Parse review for rating (simple extraction)
            const ratingMatch = review.match(/(\d+)\s*estrelas?|\*{1,5}|[1-5]\/5/i);
            const rating = ratingMatch ? ratingMatch[1] || ratingMatch[0].length || '4' : '4';
            
            document.getElementById('reviewFilename').textContent = file.name;
            document.getElementById('reviewRating').textContent = `${rating}/5 estrelas`;
            document.getElementById('reviewAnalysis').textContent = review;
            
            // Extract suggestions (simple parsing)
            const suggestions = review.match(/sugest[√µ√£]o|melhoria|recomenda/gi);
            const suggestionList = document.getElementById('reviewSuggestions');
            suggestionList.innerHTML = '';
            
            if (suggestions) {
                const lines = review.split('\n').filter(line => 
                    line.match(/[‚Ä¢\-\*]|\d+\./) || 
                    line.toLowerCase().includes('sugest') ||
                    line.toLowerCase().includes('melhori')
                );
                
                lines.slice(0, 5).forEach(suggestion => {
                    const li = document.createElement('li');
                    li.textContent = suggestion.replace(/^[‚Ä¢\-\*\d\.]\s*/, '');
                    suggestionList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'Nenhuma sugest√£o espec√≠fica encontrada na an√°lise.';
                suggestionList.appendChild(li);
            }
            
            showElement(resultDiv, 'fade-in');
            
            // Add to history
            addToHistory('review', file.name, review);
            
        } catch (error) {
            console.error('Erro na revis√£o:', error);
            showError('reviewError', `Erro ao revisar script: ${error.message}`);
        } finally {
            setLoading(reviewBtn, false);
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+B para toggle sidebar
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();
            toggleSidebar();
        }
        
        // Ctrl+Enter para gerar script
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            const activeElement = document.activeElement;
            if (activeElement && activeElement.id === 'scriptDescription') {
                generateForm.dispatchEvent(new Event('submit'));
            }
        }
    });
});

// Initialization function
function initializeApp() {
    console.log('ü§ñ Roblox AI Assistant BETA v2.1 inicializado - Especialista em Roblox Studio');
    console.log('‚úÖ JavaScript carregado com sucesso');
    console.log('üîß Testando elementos DOM...');
    
    // Test DOM elements
    const testElements = ['generateForm', 'reviewForm', 'sidebar', 'sidebarToggle'];
    testElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            console.log(`‚úÖ Elemento ${id} encontrado`);
        } else {
            console.error(`‚ùå Elemento ${id} N√ÉO encontrado`);
        }
    });
    
    // Load chat history from cookies
    loadChatHistory();
    
    // Create initial chat if none exists
    if (chatHistory.length === 0) {
        const chatId = `chat_${Date.now()}`;
        chatHistory.push({
            id: chatId,
            title: 'Nova Conversa',
            messages: [],
            createdAt: new Date().toISOString()
        });
        currentChatId = chatId;
        saveChatHistory();
    } else {
        currentChatId = chatHistory[chatHistory.length - 1].id;
    }
    
    console.log(`Nova conversa criada: ${currentChatId}`);
    
    // Test API connection
    testAPIConnection();
}

// Test API connection
async function testAPIConnection() {
    try {
        const response = await fetch(`${API_URL}/models`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${API_KEY}`
            }
        });
        
        if (response.ok) {
            console.log('‚úÖ Conex√£o com API estabelecida');
        } else {
            console.warn('‚ö†Ô∏è API connection issue:', response.status);
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel testar conex√£o com API:', error.message);
    }
}

// Sidebar functionality
function initializeSidebar() {
    console.log('Inicializando sidebar...');
    
    const sidebarToggle = document.getElementById('sidebarToggle');
    const newChatBtn = document.getElementById('newChatBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
            console.log('Toggle sidebar clicado');
            toggleSidebar();
        });
    }
    
    if (newChatBtn) {
        newChatBtn.addEventListener('click', createNewChat);
    }
    
    if (clearHistoryBtn) {
        clearHistoryBtn.addEventListener('click', clearChatHistory);
    }
    
    updateChatHistoryDisplay();
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const sidebarToggle = document.getElementById('sidebarToggle');
    
    if (!sidebar || !mainContent || !sidebarToggle) {
        console.error('Elementos da sidebar n√£o encontrados');
        return;
    }
    
    const isOpen = sidebar.classList.contains('show');
    console.log('Estado atual da sidebar:', isOpen ? 'aberta' : 'fechada');
    
    if (isOpen) {
        // Fechar sidebar
        console.log('Fechando sidebar...');
        sidebar.classList.remove('show');
        mainContent.classList.remove('shifted');
        sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
        sidebarToggle.setAttribute('aria-label', 'Abrir menu');
    } else {
        // Abrir sidebar
        console.log('Abrindo sidebar...');
        sidebar.classList.add('show');
        if (window.innerWidth > 768) {
            mainContent.classList.add('shifted');
        }
        sidebarToggle.innerHTML = '<i class="fas fa-times"></i>';
        sidebarToggle.setAttribute('aria-label', 'Fechar menu');
    }
    
    // Log da transforma√ß√£o
    console.log('Transform aplicado:', getComputedStyle(sidebar).transform);
}

function createNewChat() {
    const chatId = `chat_${Date.now()}`;
    const newChat = {
        id: chatId,
        title: 'Nova Conversa',
        messages: [],
        createdAt: new Date().toISOString()
    };
    
    chatHistory.push(newChat);
    currentChatId = chatId;
    
    // Clear current forms
    document.getElementById('scriptDescription').value = '';
    document.getElementById('scriptFile').value = '';
    hideElement(document.getElementById('generateResult'));
    hideElement(document.getElementById('reviewResult'));
    hideElement(document.getElementById('generateError'));
    hideElement(document.getElementById('reviewError'));
    
    saveChatHistory();
    updateChatHistoryDisplay();
}

function clearChatHistory() {
    if (confirm('Tem certeza que deseja limpar todo o hist√≥rico de conversas?')) {
        chatHistory = [];
        currentChatId = null;
        deleteCookie('roblox_ai_chat_history');
        createNewChat();
    }
}

function switchToChat(chatId) {
    currentChatId = chatId;
    updateChatHistoryDisplay();
    // Here you could load the specific chat messages if needed
}

function updateChatHistoryDisplay() {
    const historyContainer = document.getElementById('chatHistory');
    if (!historyContainer) return;
    
    historyContainer.innerHTML = '';
    
    chatHistory.slice(-10).reverse().forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
        chatItem.onclick = () => switchToChat(chat.id);
        
        const date = new Date(chat.createdAt).toLocaleDateString('pt-BR');
        
        // --- CORRE√á√ÉO DO ERRO ---
        // A pr√©-visualiza√ß√£o agora usa a propriedade 'input' da √∫ltima mensagem, que sempre existe.
        const lastMessage = chat.messages.length > 0 ? chat.messages[chat.messages.length - 1] : null;
        const preview = lastMessage && lastMessage.input ? 
            lastMessage.input.substring(0, 50) + '...' : 
            'Conversa vazia';
        
        chatItem.innerHTML = `
            <div class="chat-item-title">${chat.title}</div>
            <div class="chat-item-preview">${preview}</div>
            <div class="chat-item-date">${date}</div>
        `;
        
        historyContainer.appendChild(chatItem);
    });
}

// Theme functionality
function initializeTheme() {
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');
    
    // Load saved theme
    const savedTheme = getCookie('roblox_ai_theme') || 'dark';
    setTheme(savedTheme);
    
    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            setCookie('roblox_ai_theme', newTheme, COOKIE_EXPIRY_DAYS);
        });
    }
}

function setTheme(theme) {
    const body = document.body;
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');
    
    if (theme === 'light') {
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
        if (themeIcon) themeIcon.className = 'fas fa-sun';
        if (themeText) themeText.textContent = 'Modo Escuro';
    } else {
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
        if (themeIcon) themeIcon.className = 'fas fa-moon';
        if (themeText) themeText.textContent = 'Modo Claro';
    }
}

// Chat history management
function addToHistory(type, input, output) {
    if (!currentChatId) return;
    
    const chat = chatHistory.find(c => c.id === currentChatId);
    if (chat) {
        chat.messages.push({
            type: type,
            input: input,
            output: output,
            timestamp: new Date().toISOString()
        });
        
        // Update chat title based on first message
        if (chat.messages.length === 1) {
            chat.title = input.substring(0, 30) + (input.length > 30 ? '...' : '');
        }
        
        saveChatHistory();
        updateChatHistoryDisplay();
    }
}

function loadChatHistory() {
    const saved = getCookie('roblox_ai_chat_history');
    if (saved) {
        try {
            chatHistory = JSON.parse(saved);
        } catch (error) {
            console.error('Erro ao carregar hist√≥rico:', error);
            chatHistory = [];
        }
    }
}

function saveChatHistory() {
    setCookie('roblox_ai_chat_history', JSON.stringify(chatHistory), COOKIE_EXPIRY_DAYS);
}

// Utility functions
function showElement(element, animationClass = '') {
    if (element) {
        element.style.display = 'block';
        if (animationClass) {
            element.classList.add(animationClass);
        }
    }
}

function hideElement(element) {
    if (element) {
        element.style.display = 'none';
    }
}

function showError(containerId, message) {
    const errorDiv = document.getElementById(containerId);
    if (errorDiv) {
        const errorMsg = errorDiv.querySelector('[id$="ErrorMsg"]');
        if (errorMsg) {
            errorMsg.textContent = message;
        }
        showElement(errorDiv, 'fade-in');
    }
}

function setLoading(button, isLoading) {
    if (button) {
        if (isLoading) {
            button.classList.add('loading');
            button.disabled = true;
        } else {
            button.classList.remove('loading');
            button.disabled = false;
        }
    }
}

function readFileAsync(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(new Error('Erro ao ler arquivo'));
        reader.readAsText(file);
    });
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        const text = element.textContent || element.innerText;
        navigator.clipboard.writeText(text).then(() => {
            // Show temporary success message
            const originalText = element.nextElementSibling?.textContent;
            const button = element.parentElement?.querySelector('.btn-outline-success');
            if (button) {
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check me-1"></i>Copiado!';
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-success');
                
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-success');
                }, 2000);
            }
        }).catch(err => {
            console.error('Erro ao copiar:', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        });
    }
}

function saveToHistory(type) {
    const input = type === 'generate' ? 
        document.getElementById('scriptDescription').value :
        document.getElementById('scriptFile').files[0]?.name || 'Arquivo';
    
    const output = type === 'generate' ?
        document.getElementById('generatedScript').textContent :
        document.getElementById('reviewAnalysis').textContent;
    
    addToHistory(type, input, output);
    
    // Show success message
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check me-1"></i>Salvo!';
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-primary');
    }, 2000);
}

// Cookie management
function setCookie(name, value, days) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/`;
}

function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) {
            return decodeURIComponent(c.substring(nameEQ.length, c.length));
        }
    }
    return null;
}

function deleteCookie(name) {
    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
}
    </script>
</body>
</html>
